<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Mobile Shop - Admin Dashboard</title>
        <link rel="shortcut icon" type="image/png" href="../static/images/logos/logo.png" />
        <link rel="stylesheet" href="../static/css/styles.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>

    <body>
        <!--  Body Wrapper -->
        <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
             data-sidebar-position="fixed" data-header-position="fixed">
            <!-- Sidebar Start -->
            <aside class="left-sidebar">
                <!-- Sidebar scroll-->
                <div>
                    <div class="brand-logo d-flex align-items-center justify-content-between">
                        <a href="./index.html" class="text-nowrap logo-img">
                            <img src="../static/images/logos/logo.png" width="180" alt="" />
                        </a>
                        <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                            <i class="ti ti-x fs-8"></i>
                        </div>
                    </div>
                    <!-- Sidebar navigation-->
                    <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                        <ul id="sidebarnav">
                            <li class="nav-small-cap">
                                <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                                <span class="hide-menu">Home</span>
                            </li>
                            <li class="sidebar-item">
                                <a class="sidebar-link" href="./index.html" aria-expanded="false">
                                    <span>
                                        <i class="ti ti-layout-dashboard"></i>
                                    </span>
                                    <span class="hide-menu">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-small-cap">
                                <i class="ti ti-dots nav-small-cap-icon fs-4"></i>
                                <span class="hide-menu">UI COMPONENTS</span>
                            </li>
                            <li class="sidebar-item">
                                <a class="sidebar-link" href="./orders.html" aria-expanded="false">
                                    <span>
                                        <i class="ti ti-article"></i>
                                    </span>
                                    <span class="hide-menu">Order</span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a class="sidebar-link" href="./product.html" aria-expanded="false">
                                    <span>
                                        <i class="ti ti-alert-circle"></i>
                                    </span>
                                    <span class="hide-menu">Products</span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a class="sidebar-link" href="./categories.html" aria-expanded="false">
                                    <span>
                                        <i class="ti ti-cards"></i>
                                    </span>
                                    <span class="hide-menu">Categories</span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a class="sidebar-link" href="./customers.html" aria-expanded="false">
                                    <span>
                                        <i class="ti ti-file-description"></i>
                                    </span>
                                    <span class="hide-menu">Customers</span>
                                </a>
                            </li>
                            <li class="sidebar-item">
                                <a class="sidebar-link" href="./reports.html" aria-expanded="false">
                                    <span>
                                        <i class="ti ti-typography"></i>
                                    </span>
                                    <span class="hide-menu">Reports</span>
                                </a>
                            </li>

                        </ul>

                    </nav>
                    <!-- End Sidebar navigation -->
                </div>
                <!-- End Sidebar scroll-->
            </aside>
            <!--  Sidebar End -->
            <!--  Main wrapper -->
            <div class="body-wrapper">
                <!--  Header Start -->
                <header class="app-header">
                    <nav class="navbar navbar-expand-lg navbar-light">
                        <ul class="navbar-nav">
                            <li class="nav-item d-block d-xl-none">
                                <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                                    <i class="ti ti-menu-2"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                                    <i class="ti ti-bell-ringing"></i>
                                    <div class="notification bg-primary rounded-circle"></div>
                                </a>
                            </li>
                        </ul>
                        <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                            <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
                                <li class="nav-item dropdown">
                                    <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                                       aria-expanded="false">
                                        <img src="../static/images/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                                        <div class="message-body">
                                            <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                                <i class="ti ti-user fs-6"></i>
                                                <p class="mb-0 fs-3">My Profile</p>
                                            </a>
                                            <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                                <i class="ti ti-mail fs-6"></i>
                                                <p class="mb-0 fs-3">My Account</p>
                                            </a>
                                            <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                                                <i class="ti ti-list-check fs-6"></i>
                                                <p class="mb-0 fs-3">My Task</p>
                                            </a>
                                            <a href="./authentication-login.html" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </header>
                <div id="viewUserModal" class="modal">
                    <div class="modal-content">
                        <h2>User Information</h2>
                        <p><strong>ID:</strong> <span id="modalUserId"></span></p>
                        <p><strong>Name:</strong> <span id="modalUserName"></span></p>
                        <p><strong>Email:</strong> <span id="modalUserEmail"></span></p>
                        <p><strong>Registration Date:</strong> <span id="modalUserRegistrationDate"></span></p>
                        <p><strong>Address:</strong> <span id="modalUserAddress"></span></p>
                        <p><strong>Role:</strong> <span id="modalUserRole"></span></p>
                        <button id="closeModalButton">Close</button>
                    </div>
                </div>
                <!-- Modal -->
                <!-- Modal -->
                <div id="editModal" class="modal">
                    <div class="modal-content">
                        <h2>Edit Customer Information</h2>
                        <label for="userName">Name:</label>
                        <input type="text" id="userName" required><br>

                        <label for="email">Email:</label>
                        <input type="email" id="email" required><br>

                        <label for="address">Address:</label>
                        <input type="text" id="address" required><br>

                        <div class="modal-buttons">
                            <button id="saveButton">Save</button>
                            <button id="cancelButton">Cancel</button>
                        </div>
                    </div>
                </div>

                <!--  Header End -->

                <div class="container-fluid">
                    <div class="container-fluid">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title fw-semibold mb-4">Customer List</h5>
                                <input type="text" id="searchInput" placeholder="Nhập tên người dùng để tìm kiếm...">
                                <button onclick="searchUsers()">Search</button> <!-- Nút Search -->

                                <table id="userTable" class = "table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Registration Date</th>
                                            <th>Address</th>
                                            <th>Role</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be dynamically added here -->
                                    </tbody>
                                </table>
                                <div id="pagination" class="pagination">
                                    <button id="prevBtn" class="btn btn-secondary" onclick="changePage(-1)">Previous</button>
                                    <span id="pageInfo"></span>
                                    <button id="nextBtn" class="btn btn-secondary" onclick="changePage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="../static/libs/jquery/dist/jquery.min.js"></script>
        <script src="../static/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="../static/js/sidebarmenu.js"></script>
        <script src="../static/js/app.min.js"></script>
        <script src="../static/libs/simplebar/dist/simplebar.js"></script>
        <script>
                                        let currentUserId = null; // To store the currently editing user ID
                                        let users = []; // To store the fetched users
                                        let allUsers = []; // To store the complete user list for search

                                        // Function to format the date
                                        function formatDate(timestamp) {
                                            const date = new Date(timestamp);
                                            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                                        }

                                        // Function to fetch all users from the servlet and display in table
                                        function fetchUsers() {
                                            fetch('/MobilePhone/manageUser')
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        users = data; // Store fetched users
                                                        allUsers = data; // Keep a backup of all users for search
                                                        renderUsers(users); // Render users in the table
                                                    })
                                                    .catch(error => console.error('Error fetching users:', error));
                                        }
                                        // Function to render users in the table
                                        function renderUsers(users) {
                                            let tableBody = document.querySelector('#userTable tbody');
                                            tableBody.innerHTML = '';  // Clear any existing data
                                            users.forEach(user => {
                                                let row = document.createElement('tr');
                                                row.innerHTML = `
                        <td>${user.userID}</td>
                        <td>${user.userName}</td>
                        <td>${user.email}</td>
                        <td>${formatDate(user.registrationDate)}</td>
                        <td>${user.address}</td>
                        <td>${user.role}</td>
                        <td>
                            <button class="button1" onclick="viewUser(${user.userID})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="button1" onclick="editUser(${user.userID})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="button1" onclick="deleteUser(${user.userID})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                                                tableBody.appendChild(row);
                                            });
                                        }

                                        // Function to search users by name
                                        function searchUsers() {
                                            const input = document.getElementById('searchInput').value.toLowerCase();
                                            const filteredUsers = allUsers.filter(user => user.userName.toLowerCase().includes(input));
                                            renderUsers(filteredUsers);
                                        }
                                        // Function to view user details
                                        function viewUser(userId) {
                                            fetch(`/MobilePhone/manageUser?action=view&userId=${userId}`)
                                                    .then(response => response.json())
                                                    .then(user => {
                                                        // Populate modal with user data
                                                        document.getElementById('modalUserId').textContent = user.userID;
                                                        document.getElementById('modalUserName').textContent = user.userName;
                                                        document.getElementById('modalUserEmail').textContent = user.email;
                                                        document.getElementById('modalUserRegistrationDate').textContent = formatDate(user.registrationDate);
                                                        document.getElementById('modalUserAddress').textContent = user.address;
                                                        document.getElementById('modalUserRole').textContent = user.role;

                                                        // Show the modal
                                                        document.getElementById('viewUserModal').style.display = 'flex';
                                                    })
                                                    .catch(error => console.error('Error viewing user:', error));
                                        }

// Close modal function
                                        document.getElementById('closeModalButton').onclick = function () {
                                            document.getElementById('viewUserModal').style.display = 'none';
                                        };


                                        // Function to view user details


                                        // Function to edit user
                                        function editUser(userId) {
                                            currentUserId = userId; // Store the current user ID
                                            const user = users.find(u => u.userID === userId); // Find the user in the array

                                            // Populate the modal fields
                                            document.getElementById('userName').value = user.userName;
                                            document.getElementById('email').value = user.email;
                                            document.getElementById('address').value = user.address;

                                            // Show the modal
                                            document.getElementById('editModal').style.display = 'block';
                                        }

                                        // Function to save changes
                                        // Function to save changes
                                        function saveUser() {
                                            const userName = document.getElementById('userName').value.trim();
                                            const email = document.getElementById('email').value.trim();
                                            const address = document.getElementById('address').value.trim();

                                            // Validation: check if fields are empty
                                            if (!userName || !email || !address) {
                                                alert('All fields are required. Please fill in all fields.');
                                                return; // Stop execution if validation fails
                                            }

                                            const user = {
                                                userID: currentUserId,
                                                userName: userName,
                                                email: email,
                                                address: address
                                            };

                                            // Proceed with saving the user data
                                            fetch(`/MobilePhone/manageUser?action=edit&id=${currentUserId}`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify(user)
                                            })
                                                    .then(response => {
                                                        if (response.ok) {
                                                            alert('User updated successfully');
                                                            fetchUsers(); // Refresh the user list
                                                            closeModal(); // Close the modal
                                                        } else {
                                                            alert('Error updating user');
                                                        }
                                                    })
                                                    .catch(error => console.error('Error updating user:', error));
                                        }


                                        // Function to close the modal
                                        function closeModal() {
                                            document.getElementById('editModal').style.display = 'none';
                                            document.getElementById('userName').value = '';
                                            document.getElementById('email').value = '';
                                            document.getElementById('address').value = '';
                                        }

                                        // Function to delete user
                                        function deleteUser(userId) {
                                            if (confirm('Are you sure you want to delete this user?')) {
                                                fetch(`/MobilePhone/manageUser?action=delete&userId=${userId}`, {
                                                    method: 'DELETE',
                                                })
                                                        .then(response => {
                                                            if (response.ok) {
                                                                alert('User deleted successfully');
                                                                fetchUsers(); // Refresh the table after deletion
                                                            } else {
                                                                alert('Error deleting user');
                                                            }
                                                        })
                                                        .catch(error => console.error('Error deleting user:', error));
                                            }
                                        }

                                        // Fetch users when the page loads
                                        window.onload = fetchUsers;

                                        // Event listeners for modal buttons
                                        document.getElementById('saveButton').onclick = saveUser;
                                        document.getElementById('cancelButton').onclick = closeModal;
        </script>
    </body>
</html>